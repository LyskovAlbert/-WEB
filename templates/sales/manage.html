{% extends 'base.html' %}

{% block title %}Управление данными{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-funnel-fill"></i> Фильтры
            </div>
            <div class="card-body">
                <form method="get" class="row g-3" id="filterForm">
                    <div class="col-md-3">
                        <label class="form-label">Год:</label>
                        <select name="year" class="form-select">
                            <option value="">Все годы</option>
                            {% for year in years %}
                            <option value="{{ year }}" {% if selected_year == year|stringformat:"s" %}selected{% endif %}>
                                {{ year }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Месяц:</label>
                        <select name="month" class="form-select">
                            <option value="">Все месяцы</option>
                            {% for month_num, month_name in months %}
                            <option value="{{ month_num }}" {% if selected_month == month_num|stringformat:"s" %}selected{% endif %}>
                                {{ month_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">Товары:</label>
                        <div class="dropdown">
                            <button class="btn btn-outline-secondary dropdown-toggle w-100 text-start" type="button" id="productDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span id="selectedProductsText">Выберите товары</span>
                            </button>
                            <ul class="dropdown-menu w-100 p-2" aria-labelledby="productDropdown" onclick="event.stopPropagation();">
                                {% for product in products %}
                                <li>
                                    <div class="form-check">
                                        <input class="form-check-input product-checkbox" type="checkbox" name="products" value="{{ product }}" id="manageProduct{{ forloop.counter }}" 
                                               {% if product in selected_products %}checked{% endif %}>
                                        <label class="form-check-label" for="manageProduct{{ forloop.counter }}">
                                            {{ product }}
                                        </label>
                                    </div>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search"></i> Применить
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-gear-fill"></i> Управление данными о продажах</span>
                {% if user.is_authenticated %}
                <a href="{% url 'sales:add' %}" class="btn btn-success">
                    <i class="bi bi-plus-circle"></i> Добавить запись
                </a>
                {% endif %}
            </div>
            <div class="card-body">
                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}

                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Год</th>
                                <th>Месяц</th>
                                <th>Товар</th>
                                <th>Количество</th>
                                <th>Выручка (руб.)</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sale in sales_data %}
                            <tr>
                                <td>{{ sale.year }}</td>
                                <td>{{ sale.get_month_display }}</td>
                                <td>{{ sale.product_name }}</td>
                                <td>{{ sale.quantity }}</td>
                                <td>{{ sale.revenue|floatformat:2 }}</td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{% url 'sales:edit' sale.pk %}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-pencil"></i> Изменить
                                        </a>
                                        <a href="{% url 'sales:delete' sale.pk %}" class="btn btn-sm btn-outline-danger">
                                            <i class="bi bi-trash"></i> Удалить
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="6" class="text-center text-muted">Нет данных</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Пагинация -->
                {% if sales_data.has_other_pages %}
                <nav aria-label="Навигация по страницам">
                    <ul class="pagination justify-content-center">
                        {% if sales_data.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% for product in selected_products %}products={{ product }}&{% endfor %}page=1">Первая</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% for product in selected_products %}products={{ product }}&{% endfor %}page={{ sales_data.previous_page_number }}">Предыдущая</a>
                            </li>
                        {% endif %}

                        <li class="page-item active">
                            <span class="page-link">
                                Страница {{ sales_data.number }} из {{ sales_data.paginator.num_pages }}
                            </span>
                        </li>

                        {% if sales_data.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% for product in selected_products %}products={{ product }}&{% endfor %}page={{ sales_data.next_page_number }}">Следующая</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?{% if selected_year %}year={{ selected_year }}&{% endif %}{% if selected_month %}month={{ selected_month }}&{% endif %}{% for product in selected_products %}products={{ product }}&{% endfor %}page={{ sales_data.paginator.num_pages }}">Последняя</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Функция для обновления текста кнопки выбора товаров
    function updateSelectedProductsText() {
        const selectedProducts = [];
        $('.product-checkbox:checked').each(function() {
            selectedProducts.push($(this).next('label').text().trim());
        });
        
        const button = $('#selectedProductsText');
        if (selectedProducts.length === 0) {
            button.text('Выберите товары');
        } else if (selectedProducts.length === 1) {
            button.text(selectedProducts[0]);
        } else {
            button.text(`Выбрано: ${selectedProducts.length} товара(ов)`);
        }
    }
    
    // Обновляем текст при изменении чекбоксов
    $('.product-checkbox').change(function() {
        updateSelectedProductsText();
    });
    
    // Инициализируем текст при загрузке страницы
    updateSelectedProductsText();
    
    // Сохраняем параметры пагинации при фильтрации
    $('#filterForm').on('submit', function() {
        // Убираем параметр page при применении фильтров
        const url = new URL(window.location);
        url.searchParams.delete('page');
        window.history.replaceState({}, '', url);
    });
});
</script>
{% endblock %}